<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>AI-Powered Research Assistant</title>
    <style>
        /* Overall layout */
        body {
            margin: 0;
            font-family: sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar styling */
        #sidebar {
            width: 250px;
            background-color: #f7f7f7;
            border-right: 1px solid #ccc;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        #sidebar.closed {
            transform: translateX(-100%);
        }

        #sidebar .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        #sidebar .conversation-item {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #sidebar .conversation-item:hover {
            background-color: #eaeaea;
        }

        /* Main content area */
        #content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #topbar {
            background-color: #fff;
            padding: 10px;
            border-bottom: 1px solid #ccc;
            display: flex;
            align-items: center;
        }

        #topbar h1 {
            flex-grow: 1;
            margin: 0;
            font-size: 1.2em;
        }

        /* Upload form in topbar */
        #uploadForm {
            margin-left: 10px;
        }

        #main {
            flex-grow: 1;
            display: flex;
            overflow: hidden;
        }

        /* Left panel: PDF viewer using PDF.js */
        #left-panel {
            flex-grow: 1;
            padding: 20px;
            box-sizing: border-box;
            overflow: auto;
            position: relative;
        }

        .pdf-page {
            position: relative;
            margin-bottom: 20px;
        }

        .annotation-marker {
            position: absolute;
            background: rgba(255, 255, 0, 0.3);
            border: none;
            padding: 0;
            cursor: pointer;
        }

        .annotation-marker:hover {
            background: rgba(255, 255, 0, 0.5);
        }

        /* Right panel: Extraction data & annotations list */
        #right-panel {
            width: 300px;
            padding: 20px;
            border-left: 1px solid #ccc;
            overflow-y: auto;
        }

        #extractionData {
            white-space: pre-wrap;
            background: #fafafa;
            border: 1px solid #ddd;
            padding: 5px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        #annotationList {
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }

        .annotation-item {
            padding: 5px;
            border-bottom: 1px dashed #ccc;
            font-size: 0.9em;
            position: relative;
        }

        .annotation-item button {
            position: absolute;
            right: 5px;
            top: 5px;
            font-size: 0.8em;
        }

        /* Annotation Modal styling */
        #annotationModal {
            display: none;
            position: fixed;
            z-index: 1100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        #annotationModalContent {
            background-color: #fff;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 400px;
            max-width: 90%;
            position: relative;
        }

        #annotationModalContent textarea {
            width: 100%;
            height: 80px;
        }

        #annotationModalContent button {
            margin-top: 10px;
        }

        /* Button to open sidebar when closed */
        #openSidebar {
            display: none;
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1100;
        }

        /* Selection popup menu */
        #selectionPopup {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            padding: 5px;
            z-index: 1000;
        }

        /* Add styles for PDF.js text layer */
        .textLayer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            opacity: 0.2;
            line-height: 1.0;
        }

        .textLayer>span {
            color: transparent;
            position: absolute;
            white-space: pre;
            cursor: text;
            transform-origin: 0% 0%;
        }

        .textLayer .highlight {
            margin: -1px;
            padding: 1px;
            background-color: rgb(180, 0, 170);
            border-radius: 4px;
        }

        .textLayer .highlight.selected {
            background-color: rgb(0, 100, 0);
        }
    </style>
    <!-- Include PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js"></script>
    <!-- Add PDF.js text layer CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf_viewer.css">
</head>

<body>
    <!-- Sidebar for conversation list -->
    <div id="sidebar">
        <div class="sidebar-header">
            <span>Uploads</span>
            <button id="closeSidebar">X</button>
        </div>
        <div id="conversationList"></div>
    </div>
    <button id="openSidebar">â˜°</button>

    <!-- Main Content Area -->
    <div id="content">
        <div id="topbar">
            <h1>AI-Powered Research Assistant</h1>
            <form id="uploadForm" method="POST" enctype="multipart/form-data" action="/upload">
                <input type="file" name="pdfFile" accept=".pdf" required />
                <button type="submit">Upload</button>
            </form>
        </div>
        <div id="main">
            <!-- Left panel: PDF viewer -->
            <div id="left-panel">
                <h2>Paper Viewer</h2>
                <div id="pdfViewer"></div>
            </div>
            <!-- Right panel: Extraction data and annotations list -->
            <div id="right-panel">
                <h2>Extracted Data</h2>
                <pre id="extractionData"></pre>
                <h3>Annotations</h3>
                <div id="annotationList"></div>
            </div>
        </div>
    </div>

    <!-- Annotation Modal for PDF annotations -->
    <div id="annotationModal">
        <div id="annotationModalContent">
            <h3>Add Annotation</h3>
            <p id="annotationPreview" style="font-size:0.9em; color:#555;"></p>
            <label for="annotationType">Annotation type:</label>
            <select id="annotationType">
                <option value="note" selected>Note</option>
                <option value="question">Question</option>
            </select>
            <br>
            <textarea id="annotationText" placeholder="Enter your comment"></textarea>
            <br>
            <button id="saveAnnotation">Save Annotation</button>
            <button id="cancelAnnotation">Cancel</button>
        </div>
    </div>

    <!-- Add selection popup menu -->
    <div id="selectionPopup">
        <button id="addAnnotationBtn">Add annotation</button>
    </div>

    <script>
        // Global variables for PDF rendering and conversation management.
        let pdfDoc = null;
        let currentAnnotations = []; // Annotations for the current PDF.
        let currentPdfUrl = "";
        let conversations = []; // Each conversation: { id, title, pdf_url, extraction, annotations }.
        let currentConversationId = null;
        let currentSelection = null;

        // Load persistent conversations from the server on page load.
        async function loadPersistentConversations() {
            const res = await fetch("/conversations");
            conversations = await res.json();
            renderSidebar();
            if (conversations.length > 0) {
                loadConversation(conversations[0].id);
            }
        }

        // Persist the conversation list to the server.
        async function persistConversations() {
            await fetch("/conversations", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(conversations)
            });
        }

        // Render the PDF using PDF.js with annotation overlays.
        async function renderPDF(url, annotations) {
            currentPdfUrl = url;
            const viewer = document.getElementById('pdfViewer');
            viewer.innerHTML = "";
            pdfDoc = await pdfjsLib.getDocument(url).promise;

            for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                const page = await pdfDoc.getPage(pageNum);
                const scale = 1.5;
                const viewport = page.getViewport({ scale: scale });

                const pageDiv = document.createElement('div');
                pageDiv.className = 'pdf-page';
                pageDiv.style.width = viewport.width + "px";
                pageDiv.style.height = viewport.height + "px";
                pageDiv.style.position = "relative";
                pageDiv.dataset.pageNumber = pageNum;

                // Canvas layer
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                pageDiv.appendChild(canvas);

                // Text layer
                const textLayerDiv = document.createElement('div');
                textLayerDiv.className = 'textLayer';
                textLayerDiv.style.width = viewport.width + "px";
                textLayerDiv.style.height = viewport.height + "px";
                pageDiv.appendChild(textLayerDiv);

                viewer.appendChild(pageDiv);

                // Render page content
                const context = canvas.getContext('2d');
                await page.render({ canvasContext: context, viewport: viewport }).promise;

                // Render text layer
                const textContent = await page.getTextContent();
                pdfjsLib.renderTextLayer({
                    textContent: textContent,
                    container: textLayerDiv,
                    viewport: viewport,
                    textDivs: []
                });

                // Add event listener to text layer for selection
                textLayerDiv.addEventListener('mouseup', handleTextSelection);

                // Render existing annotation markers
                if (annotations) {
                    annotations.filter(a => a.page === pageNum).forEach(a => {
                        addAnnotationMarker(pageDiv, a);
                    });
                }
            }
        }

        // Add an annotation marker on the PDF page.
        function addAnnotationMarker(pageDiv, annotation) {
            const marker = document.createElement('div');
            marker.className = 'annotation-marker';
            marker.style.left = annotation.x + "px";
            marker.style.top = annotation.y + "px";
            marker.textContent = annotation.comment;
            pageDiv.appendChild(marker);
        }

        // Open the annotation modal for a given page and coordinate.
        function openAnnotationModal(page, x, y) {
            const modal = document.getElementById('annotationModal');
            modal.style.display = "block";
            modal.dataset.page = page;
            modal.dataset.x = x;
            modal.dataset.y = y;
            document.getElementById('annotationPreview').innerHTML =
                `<strong>Selected text:</strong> "${currentSelection.text}"<br>` +
                `Page ${page} at (${Math.round(x)}, ${Math.round(y)})`;
        }

        // Cancel annotation modal.
        document.getElementById('cancelAnnotation').addEventListener('click', function () {
            document.getElementById('annotationModal').style.display = "none";
            document.getElementById('annotationText').value = "";
        });

        // Save annotation from modal; include the selected annotation type.
        document.getElementById('saveAnnotation').addEventListener('click', function () {
            const comment = document.getElementById('annotationText').value.trim();
            if (!comment) {
                alert("Please enter a comment.");
                return;
            }
            const annotationType = document.getElementById('annotationType').value;
            const modal = document.getElementById('annotationModal');
            const page = parseInt(modal.dataset.page);
            const x = parseFloat(modal.dataset.x);
            const y = parseFloat(modal.dataset.y);
            const annotation = {
                id: uuidv4(),
                page,
                x,
                y,
                comment,
                type: annotationType,
                selectedText: currentSelection.text
            };
            currentAnnotations.push(annotation);
            if (currentConversationId) {
                const conv = conversations.find(c => c.id === currentConversationId);
                if (conv) {
                    conv.annotations.push(annotation);
                    renderAnnotations(conv.annotations);
                    persistConversations();
                    // Re-render PDF with updated annotations
                    renderPDF(currentPdfUrl, currentAnnotations);
                }
            }
            modal.style.display = "none";
            document.getElementById('annotationText').value = "";
        });

        // Render the annotation list in the right panel.
        function renderAnnotations(annotations) {
            const list = document.getElementById('annotationList');
            list.innerHTML = '';
            annotations.forEach(ann => {
                const div = document.createElement('div');
                div.className = 'annotation-item';
                div.innerHTML = `
                    <strong>Page ${ann.page}</strong><br>
                    <em>Selected text:</em> "${ann.selectedText}"<br>
                    <em>Comment:</em> ${ann.comment}<br>
                    <em>Type:</em> ${ann.type}`;
                div.innerHTML += ` <button onclick="askAIVerify('${ann.id}');">Ask AI to verify</button>`;
                div.innerHTML += ` <button onclick="askAIAnswer('${ann.id}');">Ask AI to answer</button>`;
                div.innerHTML += ` <button onclick="deleteAnnotation('${ann.id}');">Delete</button>`;
                list.appendChild(div);
            });
        }

        // AI verification function
        async function askAIVerify(annotationId) {
            console.log("askAIVerify called with id:", annotationId);
            const conv = conversations.find(c => c.id === currentConversationId);
            if (!conv) {
                console.error("No conversation found");
                return;
            }
            const ann = conv.annotations.find(a => a.id === annotationId);
            if (!ann) {
                console.error("No annotation found");
                return;
            }

            try {
                // Get figures from the current page and surrounding pages
                const pageNum = ann.page;
                const relevantFigures = conv.extraction.pages
                    .filter(p => Math.abs(p.page_number - pageNum) <= 1)
                    .flatMap(p => p.figures.map(f => ({ ...f, page_number: p.page_number })));

                const requestData = {
                    selectedText: ann.selectedText,
                    comment: ann.comment,
                    context: conv.extraction.pages[ann.page - 1].text,
                    figures: relevantFigures
                };

                console.log("Sending verification request with data:", requestData);

                const response = await fetch('/verify-annotation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log("Got response:", response);
                const result = await response.json();
                console.log("Parsed result:", result);

                if (result.error) {
                    console.error("Error from server:", result.error);
                    alert('Error: ' + result.error);
                    return;
                }

                // Create and show modal with AI response
                const modalHtml = `
                    <div class="ai-response-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        background: white; padding: 20px; max-width: 80%; max-height: 80%; overflow-y: auto;
                        box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 1000; border-radius: 5px;">
                        <h3>AI Verification Result</h3>
                        <div style="white-space: pre-wrap;">${result.explanation}</div>
                        <button onclick="this.parentElement.remove()" style="margin-top: 10px;">Close</button>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to verify annotation');
            }
        }

        async function askAIAnswer(annotationId) {
            console.log("askAIAnswer called with id:", annotationId);
            const conv = conversations.find(c => c.id === currentConversationId);
            if (!conv) {
                console.error("No conversation found");
                return;
            }
            const ann = conv.annotations.find(a => a.id === annotationId);
            if (!ann) {
                console.error("No annotation found");
                return;
            }

            try {
                // Get figures from the current page and surrounding pages
                const pageNum = ann.page;
                const relevantFigures = conv.extraction.pages
                    .filter(p => Math.abs(p.page_number - pageNum) <= 1)
                    .flatMap(p => p.figures.map(f => ({ ...f, page_number: p.page_number })));

                const requestData = {
                    selectedText: ann.selectedText,
                    question: ann.comment,
                    context: conv.extraction.pages[ann.page - 1].text,
                    figures: relevantFigures
                };

                console.log("Sending answer request with data:", requestData);

                const response = await fetch('/answer-question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log("Got response:", response);
                const result = await response.json();
                console.log("Parsed result:", result);

                if (result.error) {
                    console.error("Error from server:", result.error);
                    alert('Error: ' + result.error);
                    return;
                }

                // Create and show modal with AI response
                const modalHtml = `
                    <div class="ai-response-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        background: white; padding: 20px; max-width: 80%; max-height: 80%; overflow-y: auto;
                        box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 1000; border-radius: 5px;">
                        <h3>AI Answer</h3>
                        <div style="white-space: pre-wrap;">${result.answer}</div>
                        <button onclick="this.parentElement.remove()" style="margin-top: 10px;">Close</button>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to get AI answer');
            }
        }

        // Delete an annotation.
        function deleteAnnotation(annId) {
            const conv = conversations.find(c => c.id === currentConversationId);
            if (conv) {
                conv.annotations = conv.annotations.filter(a => a.id !== annId);
                currentAnnotations = conv.annotations;
                renderAnnotations(conv.annotations);
                renderPDF(currentPdfUrl, currentAnnotations);
                persistConversations();
            }
        }

        // Sidebar and conversation management.
        function renderSidebar() {
            const list = document.getElementById('conversationList');
            list.innerHTML = '';
            conversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                item.dataset.id = conv.id;
                item.innerHTML = `<span>${conv.title}</span> <button onclick="deleteConversation('${conv.id}'); event.stopPropagation();">Delete</button>`;
                item.addEventListener('click', function () {
                    loadConversation(conv.id);
                });
                list.appendChild(item);
            });
        }

        function loadConversation(id) {
            const conv = conversations.find(c => c.id === id);
            if (conv) {
                currentConversationId = id;
                currentAnnotations = conv.annotations || [];
                renderPDF(conv.pdf_url, currentAnnotations);
                document.getElementById('extractionData').textContent = JSON.stringify(conv.extraction, null, 2);
                renderAnnotations(conv.annotations);
            }
        }

        function deleteConversation(id) {
            const conv = conversations.find(c => c.id === id);
            if (conv) {
                // Collect all figure URLs from the extraction data
                const figureUrls = [];
                if (conv.extraction && conv.extraction.pages) {
                    conv.extraction.pages.forEach(page => {
                        if (page.figures) {
                            page.figures.forEach(figure => {
                                if (figure.url) {
                                    figureUrls.push(figure.url);
                                }
                            });
                        }
                    });
                }

                // Delete static files
                fetch('/delete-static-files', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pdf_url: conv.pdf_url,
                        figure_urls: figureUrls
                    })
                });
            }

            conversations = conversations.filter(c => c.id !== id);
            if (currentConversationId === id) {
                document.getElementById('pdfViewer').innerHTML = "";
                document.getElementById('extractionData').textContent = "";
                document.getElementById('annotationList').innerHTML = "";
            }
            renderSidebar();
            persistConversations();
        }

        document.getElementById('uploadForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const fileInput = document.querySelector('input[name="pdfFile"]');
            const fileName = fileInput.files[0].name;

            const response = await fetch('/upload', { method: 'POST', body: formData });
            if (!response.ok) {
                alert("Error uploading PDF");
                return;
            }
            const data = await response.json();
            const conv = {
                id: uuidv4(),
                title: fileName,
                pdf_url: data.pdf_url,
                extraction: data.extraction,
                annotations: []
            };
            conversations.push(conv);
            renderSidebar();
            loadConversation(conv.id);
            persistConversations();
        });

        // Sidebar toggle functionality.
        document.getElementById('closeSidebar').addEventListener('click', function () {
            document.getElementById('sidebar').classList.add('closed');
            document.getElementById('openSidebar').style.display = 'block';
        });
        document.getElementById('openSidebar').addEventListener('click', function () {
            document.getElementById('sidebar').classList.remove('closed');
            document.getElementById('openSidebar').style.display = 'none';
        });

        // Simple UUID generator.
        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Load persistent conversations when the page loads.
        window.onload = function () {
            loadPersistentConversations();
        }

        // Add new function to handle text selection
        function handleTextSelection(event) {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();

            if (!selectedText) {
                document.getElementById('selectionPopup').style.display = 'none';
                return;
            }

            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            const popup = document.getElementById('selectionPopup');

            popup.style.display = 'block';
            popup.style.left = `${rect.left + window.scrollX}px`;
            popup.style.top = `${rect.bottom + window.scrollY}px`;

            const pageDiv = event.target.closest('.pdf-page');
            const pageRect = pageDiv.getBoundingClientRect();

            currentSelection = {
                text: selectedText,
                page: parseInt(pageDiv.dataset.pageNumber),
                x: event.clientX - pageRect.left,
                y: event.clientY - pageRect.top
            };
        }

        // Add selection popup button handler
        document.getElementById('addAnnotationBtn').addEventListener('click', function () {
            if (currentSelection) {
                openAnnotationModal(
                    currentSelection.page,
                    currentSelection.x,
                    currentSelection.y
                );
                document.getElementById('selectionPopup').style.display = 'none';
            }
        });

        // Close selection popup when clicking outside
        document.addEventListener('mousedown', function (event) {
            if (!event.target.closest('#selectionPopup')) {
                document.getElementById('selectionPopup').style.display = 'none';
            }
        });
    </script>
</body>

</html>